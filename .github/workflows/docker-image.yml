name: Build and Push Docker Image to Aliyun ACR

on:
  push:
    branches:
      - main  # 每次推送到 main 分支都会触发自动构建和推送

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: 🧩 Checkout repository
      uses: actions/checkout@v3

    - name: 🛠️ Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: 🧱 Build Docker image
      run: |
        echo "🚀 开始构建 Docker 镜像..."
        docker build . -t 10_22:latest \
          --build-arg PIP_INDEX_URL=https://mirrors.aliyun.com/pypi/simple
        echo "✅ 镜像构建完成"

    - name: 🔐 Login to Aliyun ACR
      run: |
        echo "🔑 正在登录阿里云 ACR..."
        docker login --username=${{ secrets.ALIYUN_USER }} \
                     crpi-jsa4b3tyjwiee8rz.cn-hangzhou.personal.cr.aliyuncs.com \
                     -p ${{ secrets.ALIYUN_PASSWORD }}
        echo "✅ 登录成功"

    - name: 🚢 Tag and Push to Aliyun ACR
      run: |
        echo "🏷️ 打标签并推送镜像到 ACR..."
        docker tag 10_22:latest crpi-jsa4b3tyjwiee8rz.cn-hangzhou.personal.cr.aliyuncs.com/mypoject_one/10_22:latest
        docker push crpi-jsa4b3tyjwiee8rz.cn-hangzhou.personal.cr.aliyuncs.com/mypoject_one/10_22:latest
        echo "✅ 镜像已推送到阿里云 ACR"

    - name: ✅ Verify pushed image
      run: |
        echo "🔍 验证推送是否成功..."
        docker pull crpi-jsa4b3tyjwiee8rz.cn-hangzhou.personal.cr.aliyuncs.com/mypoject_one/10_22:latest
        echo "✅ 验证完成，镜像已可用。"
