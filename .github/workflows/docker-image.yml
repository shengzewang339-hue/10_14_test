name: Build and Push Docker Image to Aliyun ACR

on:
  push:
    branches:
      - main  # æ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯éƒ½ä¼šè§¦å‘è‡ªåŠ¨æ„å»ºå’Œæ¨é€

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ§© Checkout repository
      uses: actions/checkout@v3

    - name: ğŸ› ï¸ Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: ğŸ§± Build Docker image
      run: |
        echo "ğŸš€ å¼€å§‹æ„å»º Docker é•œåƒ..."
        docker build . -t 10_22:latest \
          --build-arg PIP_INDEX_URL=https://mirrors.aliyun.com/pypi/simple
        echo "âœ… é•œåƒæ„å»ºå®Œæˆ"

    - name: ğŸ” Login to Aliyun ACR
      run: |
        echo "ğŸ”‘ æ­£åœ¨ç™»å½•é˜¿é‡Œäº‘ ACR..."
        docker login --username=${{ secrets.ALIYUN_USER }} \
                     crpi-jsa4b3tyjwiee8rz.cn-hangzhou.personal.cr.aliyuncs.com \
                     -p ${{ secrets.ALIYUN_PASSWORD }}
        echo "âœ… ç™»å½•æˆåŠŸ"

    - name: ğŸš¢ Tag and Push to Aliyun ACR
      run: |
        echo "ğŸ·ï¸ æ‰“æ ‡ç­¾å¹¶æ¨é€é•œåƒåˆ° ACR..."
        docker tag 10_22:latest crpi-jsa4b3tyjwiee8rz.cn-hangzhou.personal.cr.aliyuncs.com/mypoject_one/10_22:latest
        docker push crpi-jsa4b3tyjwiee8rz.cn-hangzhou.personal.cr.aliyuncs.com/mypoject_one/10_22:latest
        echo "âœ… é•œåƒå·²æ¨é€åˆ°é˜¿é‡Œäº‘ ACR"

    - name: âœ… Verify pushed image
      run: |
        echo "ğŸ” éªŒè¯æ¨é€æ˜¯å¦æˆåŠŸ..."
        docker pull crpi-jsa4b3tyjwiee8rz.cn-hangzhou.personal.cr.aliyuncs.com/mypoject_one/10_22:latest
        echo "âœ… éªŒè¯å®Œæˆï¼Œé•œåƒå·²å¯ç”¨ã€‚"
