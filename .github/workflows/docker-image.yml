name: ğŸš€ Auto Deploy Django Project to Server

on:
  push:
    branches:
      - main  # æ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯è‡ªåŠ¨è§¦å‘éƒ¨ç½²

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ æ£€å‡ºä½ çš„ä»£ç 
    - name: ğŸ“¦ Checkout repository
      uses: actions/checkout@v3

    # 2ï¸âƒ£ å¯é€‰ï¼šæ„å»º Docker é•œåƒï¼ˆå¦‚æœä½ çš„é¡¹ç›®ä½¿ç”¨ Dockerï¼‰
    - name: ğŸ³ Build Docker image
      run: |
        docker build -t my_django_app:latest .

    # 3ï¸âƒ£ ä½¿ç”¨ SSH éƒ¨ç½²åˆ°ä½ çš„æœåŠ¡å™¨
    - name: ğŸš€ Deploy to remote server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: 47.118.16.173            # âœ… æœåŠ¡å™¨ IP (ä» Secrets è¯»å–)
        username: root                            # âœ… ç™»å½•ç”¨æˆ·å
        password: ${{ secrets.SERVER_PASSWORD }}  # âœ… ç™»å½•å¯†ç ï¼ˆå»ºè®®ä» Secrets è¯»å–ï¼‰
        script: |
          echo "ğŸ”„ æ‹‰å–æœ€æ–°ä»£ç ..."
          cd /opt/test/10_14_test || exit 1

          # å¦‚æœä»“åº“ä¸å­˜åœ¨ï¼Œå°±å…‹éš†ï¼›å­˜åœ¨å°±æ›´æ–°
          if [ ! -d ".git" ]; then
              git clone https://github.com/shengzewang339-hue/10_14_test.git .
          else
              git pull origin main
          fi

          echo "ğŸ³ é‡å»º Docker å®¹å™¨..."
          docker-compose down || true
          docker-compose up -d --build

          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
