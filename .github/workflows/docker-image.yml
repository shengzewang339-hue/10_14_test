name: 🚀 Auto Deploy Django Project to Server

on:
  push:
    branches:
      - main  # 每次推送到 main 分支自动触发部署

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ 检出你的代码
    - name: 📦 Checkout repository
      uses: actions/checkout@v3

    # 2️⃣ 可选：构建 Docker 镜像（如果你的项目使用 Docker）
    - name: 🐳 Build Docker image
      run: |
        docker build -t my_django_app:latest .

    # 3️⃣ 使用 SSH 部署到你的服务器
    - name: 🚀 Deploy to remote server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: 47.118.16.173            # ✅ 服务器 IP (从 Secrets 读取)
        username: root                            # ✅ 登录用户名
        password: ${{ secrets.SERVER_PASSWORD }}  # ✅ 登录密码（建议从 Secrets 读取）
        script: |
          echo "🔄 拉取最新代码..."
          cd /opt/test/10_14_test || exit 1

          # 如果仓库不存在，就克隆；存在就更新
          if [ ! -d ".git" ]; then
              git clone https://github.com/shengzewang339-hue/10_14_test.git .
          else
              git pull origin main
          fi

          echo "🐳 重建 Docker 容器..."
          docker-compose down || true
          docker-compose up -d --build

          echo "✅ 部署完成！"
